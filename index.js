const express = require('express')
const app = express()
const axios = require('axios')
const path = require("path")
const port = process.env.PORT || 3000;
app.use(express.static('static'))
app.use(express.json());
require('dotenv').config()
const { Telegraf } = require('telegraf');

const bot = new Telegraf(process.env.BOT_TOKEN);

bot.start(async (ctx) => {
  try {
    await ctx.deleteMessage();
    await bot.telegram.sendMessage(
      ctx.chat.id,
      "Hello üëã Welcome To MebelCity_Bot",
      {
        reply_markup: {
          inline_keyboard: [
            [
              { text: "üá∫üáø O`zbekcha", callback_data: "btn_uz_0" },
              { text: "üá∑üá∫ –†—É—Å—Å–∫–∏–π", callback_data: "btn_ru_0" },
            ]
          ],
        },
      }
    );
  } catch (error) {
    console.error(error);
  }
});
/* menu uz */
bot.action("btn_uz_0", async (ctx) => {
  try {
    await ctx.deleteMessage();
    
    await bot.telegram.sendMessage(ctx.chat.id, "üá∫üáø O`zbekcha", {
      reply_markup: {
        inline_keyboard: [
          [
            { text: "Catalog", callback_data: "btn_uz_1" },
            { text: "Biz bilan bog'lanish", url: "https://t.me/MebelCityOfficial" },
          ],
          [
            { text: "‚¨ÖÔ∏è Ortga qaytish", callback_data: "btn_uz_3" },
            { text: "üè† Bosh sahifa", callback_data: "btn_uz_2" },
          ],
        ],
      },
    });
  } catch (error) {
    console.error(error);
  }
});

/* menu ru */
bot.action("btn_ru_0", async (ctx) => {
  try {
    await ctx.deleteMessage();
    
    await bot.telegram.sendMessage(ctx.chat.id, "üá∑üá∫ –†—É—Å—Å–∫–∏–π", {
      reply_markup: {
        inline_keyboard: [
          [
            { text: "–ö–∞—Ç–∞–ª–æ–≥", callback_data: "btn_ru_1" },
            { text: "C–≤—è–∂–∏—Ç–µ—Å—å —Å –Ω–∞–º–∏", url: "https://t.me/MebelCityOfficial" },
          ],
          [
            { text: "‚¨ÖÔ∏è –ù–∞–∑–∞–¥", callback_data: "btn_ru_3" },
            { text: "üè† –î–æ–º–∞—à–Ω—è—è —Å—Ç—Ä–∞–Ω–∏—Ü–∞", callback_data: "btn_ru_2" },
          ],
        ],
      },
    });
  } catch (error) {
    console.error(error);
  }
});

/* catalog uz */
bot.action("btn_uz_1", async (ctx) => {
  try {
    await ctx.deleteMessage();
    await bot.telegram.sendMessage(ctx.chat.id, "üá∫üáø O`zbekcha", {
      reply_markup: {
        inline_keyboard: [
          [
            { text: "Offis mebellar toplami", callback_data: "btn_uz_4" },
            { text: "Offis mebellari", callback_data: "btn_uz_5" },
          ],
          [
            { text: "Loft uslubidagi mebellar", callback_data: "btn_uz_6" },
            { text: "Offis yumshoq mebellar toplami", callback_data: "btn_uz_7" },
          ],
          [
            { text: "Bizning salon", callback_data: "btn_uz_8" },
            { text: "Web sahifamizga otish", url: "https://mebelcity.uz" },
          ],
          [
            { text: "‚¨ÖÔ∏è Ortga qaytish", callback_data: "btn_uz_0" },
            { text: "üè† Bosh sahifa", callback_data: "btn_uz_2" },
          ],
        ],
      },
    });
  } catch (error) {
    console.error(error);
  }
});
/* catalog ru */
bot.action("btn_ru_1", async (ctx) => {
  try {
    await ctx.deleteMessage();
    await bot.telegram.sendMessage(ctx.chat.id, "üá∑üá∫ –†—É—Å—Å–∫–∏–π", {
      reply_markup: {
        inline_keyboard: [
          [
            { text: "–ù–∞–±–æ—Ä –û—Ñ—Ñ–∏—Å–Ω—ãx –º–µ–±–µ–ª–æ–≤", callback_data: "btn_ru_4" },
            { text: "–û—Ñ—Ñ–∏—Å–Ω—ã–µ –º–µ–±–µ–ª–∏", callback_data: "btn_ru_5" },
          ],
          [
            { text: "–ú–µ–±–µ–ª—å –≤ —Å—Ç–∏–ª–µ –ª–æ—Ñ—Ç", callback_data: "btn_ru_6" },
            { text: "–ù–∞–±–æ—Ä –º—è–≥–∫–æ–≥–æ –º–µ–±–µ–ª–∏", callback_data: "btn_ru_7" },
          ],
          [
            { text: "–ù–∞—à —Å–∞–ª–æ–Ω", callback_data: "btn_ru_8" },
            { text: "–ü–µ—Ä–µ–π—Ç–∏ –Ω–∞ –Ω–∞—à—É –≤–µ–±-—Å—Ç—Ä–∞–Ω–∏—Ü—É", url: "https://mebelcity.uz" },
          ],
          [
            { text: "‚¨ÖÔ∏è –ù–∞–∑–∞–¥", callback_data: "btn_ru_0" },
            { text: "üè† –î–æ–º–∞—à–Ω—è—è —Å—Ç—Ä–∞–Ω–∏—Ü–∞", callback_data: "btn_ru_2" },
          ],
        ],
      },
    });
  } catch (error) {
    console.error(error);
  }
});

/* ===== Home Uz ===== */
bot.action('btn_uz_2', async (ctx) => {
  try {
    await ctx.deleteMessage();
    await bot.telegram.sendMessage(ctx.chat.id, "üá∫üáø O`zbekcha", {
      reply_markup: {
        inline_keyboard: [
          [
            { text: "Catalog", callback_data: "btn_uz_1" },
            { text: "Biz bilan bog'lanish", url: "https://t.me/MebelCityOfficial" },
          ],
          [
            { text: "‚¨ÖÔ∏è Ortga qaytish", callback_data: "btn_uz_3" },
            { text: "üè† Bosh sahifa", callback_data: "btn_uz_2" },
          ],
        ],
      },
    });
  } catch (error) {
    console.error(error);
  }
});
/* ===== Home Ru ===== */
bot.action('btn_ru_2', async (ctx) => {
  try {
    await ctx.deleteMessage();
    await bot.telegram.sendMessage(ctx.chat.id, "üá∑üá∫ –†—É—Å—Å–∫–∏–π", {
      reply_markup: {
        inline_keyboard: [
          [
            { text: "–ö–∞—Ç–∞–ª–æ–≥", callback_data: "btn_ru_1" },
            { text: "C–≤—è–∂–∏—Ç–µ—Å—å —Å –Ω–∞–º–∏", url: "https://t.me/MebelCityOfficial" },
          ],
          [
            { text: "‚¨ÖÔ∏è –ù–∞–∑–∞–¥", callback_data: "btn_ru_3" },
            { text: "üè† –î–æ–º–∞—à–Ω—è—è —Å—Ç—Ä–∞–Ω–∏—Ü–∞", callback_data: "btn_ru_2" },
          ],
        ],
      },
    });
  } catch (error) {
    console.error(error);
  }
});

/* ===== Back UZ ===== */
bot.action('btn_uz_3', async(ctx)=>{
  try {
    await ctx.deleteMessage();
    await bot.telegram.sendMessage(
      ctx.chat.id,
      "Hello üëã Welcome To MebelCity_Bot",
      {
        reply_markup: {
          inline_keyboard: [
            [
              { text: "üá∫üáø O`zbekcha", callback_data: "btn_uz_0" },
              { text: "üá∑üá∫ –†—É—Å—Å–∫–∏–π", callback_data: "btn_ru_0" },
            ]
          ],
        },
      }
    );
  } catch (error) {
    console.error(error);
  }
})
/* ===== Back RU===== */
bot.action('btn_ru_3', async(ctx)=>{
  try {
    await ctx.deleteMessage();
    await bot.telegram.sendMessage(
      ctx.chat.id,
      "Hello üëã Welcome To MebelCity_Bot",
      {
        reply_markup: {
          inline_keyboard: [
            [
              { text: "üá∫üáø O`zbekcha", callback_data: "btn_uz_0" },
              { text: "üá∑üá∫ –†—É—Å—Å–∫–∏–π", callback_data: "btn_ru_0" },
            ]
          ],
        },
      }
    );
  } catch (error) {
    console.error(error);
  }
})

/* ====== Address UZ===== */
function address(btn, type, lat, lan) {
  bot.action(btn, async (ctx) => {
    try {
      await ctx.deleteMessage();
      await bot.telegram.sendPhoto(ctx.chat.id, {source: './images/bisSalon.jpg', width: 300, height: 200 }, {caption: `${type}`}, );
      await bot.telegram.sendLocation(ctx.chat.id, lat, lan, {reply_markup:{
        inline_keyboard: [
          [
            { text: "‚¨ÖÔ∏è Ortga qaytish", callback_data: "btn_uz_1" },
            { text: "üè† Bosh sahifa", callback_data: "btn_uz_2" },
          ],
        ],
      },} );
    } catch (error) {
      console.error(error);
    }
  });
}
/* ====== Address RU===== */
function addressru(btn, type, lat, lan) {
  bot.action(btn, async (ctx) => {
    try {
      await ctx.deleteMessage();
      await bot.telegram.sendPhoto(ctx.chat.id, {source: './images/bisSalon.jpg'}, {caption: `${type}`}, );
      await bot.telegram.sendLocation(ctx.chat.id, lat, lan, {reply_markup:{
        inline_keyboard: [
          [
            { text: "‚¨ÖÔ∏è –ù–∞–∑–∞–¥", callback_data: "btn_ru_1" },
            { text: "üè† –î–æ–º–∞—à–Ω—è—è —Å—Ç—Ä–∞–Ω–∏—Ü–∞", callback_data: "btn_ru_2" },
          ],
        ],
      },} );
    } catch (error) {
      console.error(error);
    }
  });
}
/* UZ */
address(
  "btn_uz_8",
  `Toshkent shaxri, Chilonzor tumani, Kichik xalqa yo‚Äôli, Bog‚Äôiston 1-chi tor ko‚Äôchasi, 58-uy, 2-chi qavat.`,
  41.30150062376062, 69.19410130613433
);
/* RU */
addressru("btn_ru_8",
`–ì–æ—Ä–æ–¥ –¢–∞—à–∫–µ–Ω—Ç –ß–∏–ª–∞–Ω–∑–∞—Ä—Å–∫–∏–π —Ä–∞–π–æ–Ω –£–ª–∏—Ü–∞ –ë–æ–≥–∏—Å—Ç–æ–Ω 1-–ø—Ä–æ–µ–∑–¥ –ö–∏—á–∏–∫ —Ö–∞–ª–∫–∞ –π—É–ª–∏, –¥–æ–º 58 (2-—ç—Ç–∞–∂).`,
41.30150062376062, 69.19410130613433)
/* ====== Address ===== */


function category(btn, url, title, times, back, back_title, home, home_title, lang) {
  bot.action(btn, async(ctx)=>{
    try {
      await ctx.deleteMessage();
      var rate;
      var time = times 
      await axios.get(`https://mebels.mebelcity.uz/api/${url}`, {headers:{
        'Accept-Language': lang
      }}).then(response => {
        rate = response?.data?.datas
        rate?.forEach((el,i)=>{
          const name = lang=="uz" ? el?.name_uz?.split(" /n ")?.join(" ")?.toString() : el?.name_ru?.split(" /n ")?.join(" ")?.toString()
          const size = lang=="uz" ? el?.size_uz?.split(" /n ")?.join("\n")?.toString() : el?.size_ru?.split(" /n ")?.join("\n")?.toString()
          const line = '______________________'
          bot.telegram.sendPhoto(ctx.chat.id, {url: `https://mebels.mebelcity.uz/storage/${el?.image}`}, {caption: `\n\n${ name }\n${size}\n${el?.price}\n${line}`});
          time += times 
        })  
      })
      
      setTimeout(() => {
        bot.telegram.sendMessage(
          ctx.chat.id, title, {
            reply_markup: {
              inline_keyboard: [
                [
                  { text: `‚¨ÖÔ∏è ${back_title}`, callback_data: back },
                  { text: `üè† ${home_title}`, callback_data: home },
                ],
              ],
            },
          }
        )
      }, time);
      
    } catch (error) {
      console.error(error);
    }
  })
}
/* UZ  */
category('btn_uz_4', 'allmebel', 'OFFIS MEBELLAR TOPLAMI', 1000, 'btn_uz_1', 'Ortga qaytish', 'btn_uz_2', 'Bosh sahifa', 'uz')
category('btn_uz_5', 'mebel', 'MEBELLAR TOPLAMI', 200,'btn_uz_1', 'Ortga qaytish', 'btn_uz_2', 'Bosh sahifa', 'uz')
category('btn_uz_6', 'loftmebel', 'LOFT MEBELLAR TOPLAMI', 1000, 'btn_uz_1', 'Ortga qaytish', 'btn_uz_2', 'Bosh sahifa', 'uz')
category('btn_uz_7', 'softmebel', 'YUMSHOQ MEBELLAR TOPLAMI', 1000, 'btn_uz_1', 'Ortga qaytish', 'btn_uz_2', 'Bosh sahifa', 'uz')
/* RU */
category('btn_ru_4', 'allmebel', '–ù–ê–ë–û–† –û–§–ò–°–ù–´–• –ú–ï–ë–ï–õ–û–í', 1000, 'btn_ru_1', '–ù–∞–∑–∞–¥', 'btn_ru_2', '–î–æ–º–∞—à–Ω—è—è —Å—Ç—Ä–∞–Ω–∏—Ü–∞', 'ru')
category('btn_ru_5', 'mebel', '–û–§–ò–°–ù–´–ï –ú–ï–ë–ï–õ–ò', 200, 'btn_ru_1', '–ù–∞–∑–∞–¥', 'btn_ru_2', '–î–æ–º–∞—à–Ω—è—è —Å—Ç—Ä–∞–Ω–∏—Ü–∞', 'ru')
category('btn_ru_6', 'loftmebel', '–û–§–ò–°–ù–´–ï –ú–ï–ë–ï–õ–ò –í –°–¢–ò–õ–ò –õ–û–§–¢', 1000, 'btn_ru_1', '–ù–∞–∑–∞–¥', 'btn_ru_2', '–î–æ–º–∞—à–Ω—è—è —Å—Ç—Ä–∞–Ω–∏—Ü–∞', 'ru')
category('btn_ru_7', 'softmebel', '–ù–ê–ë–û–† –ú–Ø–ì–ö–û–ì–û –ú–ï–ë–ï–õ–ò', 1000, 'btn_ru_1', '–ù–∞–∑–∞–¥', 'btn_ru_2', '–î–æ–º–∞—à–Ω—è—è —Å—Ç—Ä–∞–Ω–∏—Ü–∞', 'ru')



bot.launch();

// Enable graceful stop
process.once('SIGINT', () => bot.stop('SIGINT'));
process.once('SIGTERM', () => bot.stop('SIGTERM'));